---
name: test-future

# This workflow detects breakage against upcoming releases of dependencies
# even in the absence of activity in Darker's own repository.

on:  # yamllint disable-line rule:truthy
  schedule:
    - cron: "05 20 * * 6"
  workflow_dispatch:

jobs:
  test-future:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/setup.cfg
            **/pyproject.toml
          activate-environment: true
      - name: Install Darker and its dependencies
        run: uv pip install --group=dev .
      - name: Upgrade dependencies to future versions
        # Upgrade Black, Flynt, Isort, pyupgrade and Darkgraylib from GitHub.
        # This can't be done in the same uv invocation as installing Darker
        # since Darker might place an upper limit on Black, Flynt and/or Isort during
        # compatibility fixing periods.
        run: |
          uv pip install \
            --upgrade \
            --requirements=constraints-future.txt \
            --group=dev \
            -e . packaging setuptools
      - name: Test with pytest
        run: uv run pytest
      - name: Note a possible dependency incompatibility and required actions
        if: failure()
        run: |
          uvx \
            --from darkgray-dev-tools \
            darkgray_suggest_constraint Pygments toml
